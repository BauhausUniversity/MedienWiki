if(typeof Effect=="undefined"){throw ("controls.js requires including script.aculo.us' effects.js library");}var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(_1,_2,_3){_1=$(_1);this.element=_1;this.update=$(_2);this.hasFocus=false;this.changed=false;this.active=false;this.index=0;this.entryCount=0;this.oldElementValue=this.element.value;if(this.setOptions){this.setOptions(_3);}else{this.options=_3||{};}this.options.paramName=this.options.paramName||this.element.name;this.options.tokens=this.options.tokens||[];this.options.frequency=this.options.frequency||0.4;this.options.minChars=this.options.minChars||1;this.options.onShow=this.options.onShow||function(_4,_5){if(!_5.style.position||_5.style.position=="absolute"){_5.style.position="absolute";Position.clone(_4,_5,{setHeight:false,offsetTop:_4.offsetHeight});}Effect.Appear(_5,{duration:0.15});};this.options.onHide=this.options.onHide||function(_6,_7){new Effect.Fade(_7,{duration:0.15});};if(typeof (this.options.tokens)=="string"){this.options.tokens=new Array(this.options.tokens);}if(!this.options.tokens.include("\n")){this.options.tokens.push("\n");}this.observer=null;this.element.setAttribute("autocomplete","off");Element.hide(this.update);Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this));Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this));},show:function(){if(Element.getStyle(this.update,"display")=="none"){this.options.onShow(this.element,this.update);}if(!this.iefix&&(Prototype.Browser.IE)&&(Element.getStyle(this.update,"position")=="absolute")){new Insertion.After(this.update,"<iframe id=\""+this.update.id+"_iefix\" "+"style=\"display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);\" "+"src=\"javascript:false;\" frameborder=\"0\" scrolling=\"no\"></iframe>");this.iefix=$(this.update.id+"_iefix");}if(this.iefix){setTimeout(this.fixIEOverlapping.bind(this),50);}},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:(!this.update.style.height)});this.iefix.style.zIndex=1;this.update.style.zIndex=2;Element.show(this.iefix);},hide:function(){this.stopIndicator();if(Element.getStyle(this.update,"display")!="none"){this.options.onHide(this.element,this.update);}if(this.iefix){Element.hide(this.iefix);}},startIndicator:function(){if(this.options.indicator){Element.show(this.options.indicator);}},stopIndicator:function(){if(this.options.indicator){Element.hide(this.options.indicator);}},onKeyPress:function(_8){if(this.active){switch(_8.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();Event.stop(_8);case Event.KEY_ESC:this.hide();this.active=false;Event.stop(_8);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(_8);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(_8);return;}}else{if(_8.keyCode==Event.KEY_TAB||_8.keyCode==Event.KEY_RETURN||(Prototype.Browser.WebKit>0&&_8.keyCode==0)){return;}}this.changed=true;this.hasFocus=true;if(this.observer){clearTimeout(this.observer);}this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000);},activate:function(){this.changed=false;this.hasFocus=true;this.getUpdatedChoices();},onHover:function(_9){var _a=Event.findElement(_9,"LI");if(this.index!=_a.autocompleteIndex){this.index=_a.autocompleteIndex;this.render();}Event.stop(_9);},onClick:function(_b){var _c=Event.findElement(_b,"LI");this.index=_c.autocompleteIndex;this.selectEntry();this.hide();},onBlur:function(_d){setTimeout(this.hide.bind(this),250);this.hasFocus=false;this.active=false;},render:function(){if(this.entryCount>0){for(var i=0;i<this.entryCount;i++){this.index==i?Element.addClassName(this.getEntry(i),"selected"):Element.removeClassName(this.getEntry(i),"selected");}if(this.hasFocus){this.show();this.active=true;}}else{this.active=false;this.hide();}},markPrevious:function(){if(this.index>0){this.index--;}else{this.index=this.entryCount-1;}this.getEntry(this.index).scrollIntoView(true);},markNext:function(){if(this.index<this.entryCount-1){this.index++;}else{this.index=0;}this.getEntry(this.index).scrollIntoView(false);},getEntry:function(_e){return this.update.firstChild.childNodes[_e];},getCurrentEntry:function(){return this.getEntry(this.index);},selectEntry:function(){this.active=false;this.updateElement(this.getCurrentEntry());},updateElement:function(_f){if(this.options.updateElement){this.options.updateElement(_f);return;}var _10="";if(this.options.select){var _11=$(_f).select("."+this.options.select)||[];if(_11.length>0){_10=Element.collectTextNodes(_11[0],this.options.select);}}else{_10=Element.collectTextNodesIgnoreClass(_f,"informal");}var _12=this.getTokenBounds();if(_12[0]!=-1){var _13=this.element.value.substr(0,_12[0]);var _14=this.element.value.substr(_12[0]).match(/^\s+/);if(_14){_13+=_14[0];}this.element.value=_13+_10+this.element.value.substr(_12[1]);}else{this.element.value=_10;}this.oldElementValue=this.element.value;this.element.focus();if(this.options.afterUpdateElement){this.options.afterUpdateElement(this.element,_f);}},updateChoices:function(_15){if(!this.changed&&this.hasFocus){this.update.innerHTML=_15;Element.cleanWhitespace(this.update);Element.cleanWhitespace(this.update.down());if(this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var i=0;i<this.entryCount;i++){var _16=this.getEntry(i);_16.autocompleteIndex=i;this.addObservers(_16);}}else{this.entryCount=0;}this.stopIndicator();this.index=0;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry();this.hide();}else{this.render();}}},addObservers:function(_17){Event.observe(_17,"mouseover",this.onHover.bindAsEventListener(this));Event.observe(_17,"click",this.onClick.bindAsEventListener(this));},onObserverEvent:function(){this.changed=false;this.tokenBounds=null;if(this.getToken().length>=this.options.minChars){this.getUpdatedChoices();}else{this.active=false;this.hide();}this.oldElementValue=this.element.value;},getToken:function(){var _18=this.getTokenBounds();return this.element.value.substring(_18[0],_18[1]).strip();},getTokenBounds:function(){if(null!=this.tokenBounds){return this.tokenBounds;}var _19=this.element.value;if(_19.strip().empty()){return [-1,0];}var _1a=arguments.callee.getFirstDifferencePos(_19,this.oldElementValue);var _1b=(_1a==this.oldElementValue.length?1:0);var _1c=-1,_1d=_19.length;var tp;for(var _1e=0,l=this.options.tokens.length;_1e<l;++_1e){tp=_19.lastIndexOf(this.options.tokens[_1e],_1a+_1b-1);if(tp>_1c){_1c=tp;}tp=_19.indexOf(this.options.tokens[_1e],_1a+_1b);if(-1!=tp&&tp<_1d){_1d=tp;}}return (this.tokenBounds=[_1c+1,_1d]);}});Autocompleter.Base.prototype.getTokenBounds.getFirstDifferencePos=function(_1f,_20){var _21=Math.min(_1f.length,_20.length);for(var _22=0;_22<_21;++_22){if(_1f[_22]!=_20[_22]){return _22;}}return _21;};Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(_23,_24,url,_25){this.baseInitialize(_23,_24,_25);this.options.asynchronous=true;this.options.onComplete=this.onComplete.bind(this);this.options.defaultParams=this.options.parameters||null;this.url=url;},getUpdatedChoices:function(){this.startIndicator();var _26=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,_26):_26;if(this.options.defaultParams){this.options.parameters+="&"+this.options.defaultParams;}new Ajax.Request(this.url,this.options);},onComplete:function(_27){this.updateChoices(_27.responseText);}});Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(_28,_29,_2a,_2b){this.baseInitialize(_28,_29,_2b);this.options.array=_2a;},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this));},setOptions:function(_2c){this.options=Object.extend({choices:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false,selector:function(_2d){var ret=[];var _2e=[];var _2f=_2d.getToken();var _30=0;for(var i=0;i<_2d.options.array.length&&ret.length<_2d.options.choices;i++){var _31=_2d.options.array[i];var _32=_2d.options.ignoreCase?_31.toLowerCase().indexOf(_2f.toLowerCase()):_31.indexOf(_2f);while(_32!=-1){if(_32==0&&_31.length!=_2f.length){ret.push("<li><strong>"+_31.substr(0,_2f.length)+"</strong>"+_31.substr(_2f.length)+"</li>");break;}else{if(_2f.length>=_2d.options.partialChars&&_2d.options.partialSearch&&_32!=-1){if(_2d.options.fullSearch||/\s/.test(_31.substr(_32-1,1))){_2e.push("<li>"+_31.substr(0,_32)+"<strong>"+_31.substr(_32,_2f.length)+"</strong>"+_31.substr(_32+_2f.length)+"</li>");break;}}}_32=_2d.options.ignoreCase?_31.toLowerCase().indexOf(_2f.toLowerCase(),_32+1):_31.indexOf(_2f,_32+1);}}if(_2e.length){ret=ret.concat(_2e.slice(0,_2d.options.choices-ret.length));}return "<ul>"+ret.join("")+"</ul>";}},_2c||{});}});Field.scrollFreeActivate=function(_33){setTimeout(function(){Field.activate(_33);},1);};Ajax.InPlaceEditor=Class.create({initialize:function(_34,url,_35){this.url=url;this.element=_34=$(_34);this.prepareOptions();this._controls={};arguments.callee.dealWithDeprecatedOptions(_35);Object.extend(this.options,_35||{});if(!this.options.formId&&this.element.id){this.options.formId=this.element.id+"-inplaceeditor";if($(this.options.formId)){this.options.formId="";}}if(this.options.externalControl){this.options.externalControl=$(this.options.externalControl);}if(!this.options.externalControl){this.options.externalControlOnly=false;}this._originalBackground=this.element.getStyle("background-color")||"transparent";this.element.title=this.options.clickToEditText;this._boundCancelHandler=this.handleFormCancellation.bind(this);this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this);this._boundFailureHandler=this.handleAJAXFailure.bind(this);this._boundSubmitHandler=this.handleFormSubmission.bind(this);this._boundWrapperHandler=this.wrapUp.bind(this);this.registerListeners();},checkForEscapeOrReturn:function(e){if(!this._editing||e.ctrlKey||e.altKey||e.shiftKey){return;}if(Event.KEY_ESC==e.keyCode){this.handleFormCancellation(e);}else{if(Event.KEY_RETURN==e.keyCode){this.handleFormSubmission(e);}}},createControl:function(_36,_37,_38){var _39=this.options[_36+"Control"];var _3a=this.options[_36+"Text"];if("button"==_39){var btn=document.createElement("input");btn.type="submit";btn.value=_3a;btn.className="editor_"+_36+"_button";if("cancel"==_36){btn.onclick=this._boundCancelHandler;}this._form.appendChild(btn);this._controls[_36]=btn;}else{if("link"==_39){var _3b=document.createElement("a");_3b.href="#";_3b.appendChild(document.createTextNode(_3a));_3b.onclick="cancel"==_36?this._boundCancelHandler:this._boundSubmitHandler;_3b.className="editor_"+_36+"_link";if(_38){_3b.className+=" "+_38;}this._form.appendChild(_3b);this._controls[_36]=_3b;}}},createEditField:function(){var _3c=(this.options.loadTextURL?this.options.loadingText:this.getText());var fld;if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){fld=document.createElement("input");fld.type="text";var _3d=this.options.size||this.options.cols||0;if(0<_3d){fld.size=_3d;}}else{fld=document.createElement("textarea");fld.rows=(1>=this.options.rows?this.options.autoRows:this.options.rows);fld.cols=this.options.cols||40;}fld.name=this.options.paramName;fld.value=_3c;fld.className="editor_field";if(this.options.submitOnBlur){fld.onblur=this._boundSubmitHandler;}this._controls.editor=fld;if(this.options.loadTextURL){this.loadExternalText();}this._form.appendChild(this._controls.editor);},createForm:function(){var ipe=this;function _3e(_3f,_40){var _41=ipe.options["text"+_3f+"Controls"];if(!_41||_40===false){return;}ipe._form.appendChild(document.createTextNode(_41));};this._form=$(document.createElement("form"));this._form.id=this.options.formId;this._form.addClassName(this.options.formClassName);this._form.onsubmit=this._boundSubmitHandler;this.createEditField();if("textarea"==this._controls.editor.tagName.toLowerCase()){this._form.appendChild(document.createElement("br"));}if(this.options.onFormCustomization){this.options.onFormCustomization(this,this._form);}_3e("Before",this.options.okControl||this.options.cancelControl);this.createControl("ok",this._boundSubmitHandler);_3e("Between",this.options.okControl&&this.options.cancelControl);this.createControl("cancel",this._boundCancelHandler,"editor_cancel");_3e("After",this.options.okControl||this.options.cancelControl);},destroy:function(){if(this._oldInnerHTML){this.element.innerHTML=this._oldInnerHTML;}this.leaveEditMode();this.unregisterListeners();},enterEditMode:function(e){if(this._saving||this._editing){return;}this._editing=true;this.triggerCallback("onEnterEditMode");if(this.options.externalControl){this.options.externalControl.hide();}this.element.hide();this.createForm();this.element.parentNode.insertBefore(this._form,this.element);if(!this.options.loadTextURL){this.postProcessEditField();}if(e){Event.stop(e);}},enterHover:function(e){if(this.options.hoverClassName){this.element.addClassName(this.options.hoverClassName);}if(this._saving){return;}this.triggerCallback("onEnterHover");},getText:function(){return this.element.innerHTML.unescapeHTML();},handleAJAXFailure:function(_42){this.triggerCallback("onFailure",_42);if(this._oldInnerHTML){this.element.innerHTML=this._oldInnerHTML;this._oldInnerHTML=null;}},handleFormCancellation:function(e){this.wrapUp();if(e){Event.stop(e);}},handleFormSubmission:function(e){var _43=this._form;var _44=$F(this._controls.editor);this.prepareSubmission();var _45=this.options.callback(_43,_44)||"";if(Object.isString(_45)){_45=_45.toQueryParams();}_45.editorId=this.element.id;if(this.options.htmlResponse){var _46=Object.extend({evalScripts:true},this.options.ajaxOptions);Object.extend(_46,{parameters:_45,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Updater({success:this.element},this.url,_46);}else{var _46=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(_46,{parameters:_45,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler});new Ajax.Request(this.url,_46);}if(e){Event.stop(e);}},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName);this.removeForm();this.leaveHover();this.element.style.backgroundColor=this._originalBackground;this.element.show();if(this.options.externalControl){this.options.externalControl.show();}this._saving=false;this._editing=false;this._oldInnerHTML=null;this.triggerCallback("onLeaveEditMode");},leaveHover:function(e){if(this.options.hoverClassName){this.element.removeClassName(this.options.hoverClassName);}if(this._saving){return;}this.triggerCallback("onLeaveHover");},loadExternalText:function(){this._form.addClassName(this.options.loadingClassName);this._controls.editor.disabled=true;var _47=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(_47,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(_48){this._form.removeClassName(this.options.loadingClassName);var _49=_48.responseText;if(this.options.stripLoadedTextTags){_49=_49.stripTags();}this._controls.editor.value=_49;this._controls.editor.disabled=false;this.postProcessEditField();}.bind(this),onFailure:this._boundFailureHandler});new Ajax.Request(this.options.loadTextURL,_47);},postProcessEditField:function(){var fpc=this.options.fieldPostCreation;if(fpc){$(this._controls.editor)["focus"==fpc?"focus":"activate"]();}},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions);Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks);[this._extraDefaultOptions].flatten().compact().each(function(_4a){Object.extend(this.options,_4a);}.bind(this));},prepareSubmission:function(){this._saving=true;this.removeForm();this.leaveHover();this.showSaving();},registerListeners:function(){this._listeners={};var _4b;$H(Ajax.InPlaceEditor.Listeners).each(function(_4c){_4b=this[_4c.value].bind(this);this._listeners[_4c.key]=_4b;if(!this.options.externalControlOnly){this.element.observe(_4c.key,_4b);}if(this.options.externalControl){this.options.externalControl.observe(_4c.key,_4b);}}.bind(this));},removeForm:function(){if(!this._form){return;}this._form.remove();this._form=null;this._controls={};},showSaving:function(){this._oldInnerHTML=this.element.innerHTML;this.element.innerHTML=this.options.savingText;this.element.addClassName(this.options.savingClassName);this.element.style.backgroundColor=this._originalBackground;this.element.show();},triggerCallback:function(_4d,arg){if("function"==typeof this.options[_4d]){this.options[_4d](this,arg);}},unregisterListeners:function(){$H(this._listeners).each(function(_4e){if(!this.options.externalControlOnly){this.element.stopObserving(_4e.key,_4e.value);}if(this.options.externalControl){this.options.externalControl.stopObserving(_4e.key,_4e.value);}}.bind(this));},wrapUp:function(_4f){this.leaveEditMode();this._boundComplete(_4f,this.element);}});Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy});Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function(_50,_51,url,_52){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions;_50(_51,url,_52);},createEditField:function(){var _53=document.createElement("select");_53.name=this.options.paramName;_53.size=1;this._controls.editor=_53;this._collection=this.options.collection||[];if(this.options.loadCollectionURL){this.loadCollection();}else{this.checkForExternalText();}this._form.appendChild(this._controls.editor);},loadCollection:function(){this._form.addClassName(this.options.loadingClassName);this.showLoadingText(this.options.loadingCollectionText);var _54=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(_54,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(_55){var js=_55.responseText.strip();if(!/^\[.*\]$/.test(js)){throw ("Server returned an invalid collection representation.");}this._collection=eval(js);this.checkForExternalText();}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loadCollectionURL,_54);},showLoadingText:function(_56){this._controls.editor.disabled=true;var _57=this._controls.editor.firstChild;if(!_57){_57=document.createElement("option");_57.value="";this._controls.editor.appendChild(_57);_57.selected=true;}_57.update((_56||"").stripScripts().stripTags());},checkForExternalText:function(){this._text=this.getText();if(this.options.loadTextURL){this.loadExternalText();}else{this.buildOptionList();}},loadExternalText:function(){this.showLoadingText(this.options.loadingText);var _58=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(_58,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(_59){this._text=_59.responseText.strip();this.buildOptionList();}.bind(this),onFailure:this.onFailure});new Ajax.Request(this.options.loadTextURL,_58);},buildOptionList:function(){this._form.removeClassName(this.options.loadingClassName);this._collection=this._collection.map(function(_5a){return 2===_5a.length?_5a:[_5a,_5a].flatten();});var _5b=("value" in this.options)?this.options.value:this._text;var _5c=this._collection.any(function(_5d){return _5d[0]==_5b;}.bind(this));this._controls.editor.update("");var _5e;this._collection.each(function(_5f,_60){_5e=document.createElement("option");_5e.value=_5f[0];_5e.selected=_5c?_5f[0]==_5b:0==_60;_5e.appendChild(document.createTextNode(_5f[1]));this._controls.editor.appendChild(_5e);}.bind(this));this._controls.editor.disabled=false;Field.scrollFreeActivate(this._controls.editor);}});Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(_61){if(!_61){return;}function _62(_63,_64){if(_63 in _61||_64===undefined){return;}_61[_63]=_64;};_62("cancelControl",(_61.cancelLink?"link":(_61.cancelButton?"button":_61.cancelLink==_61.cancelButton==false?false:undefined)));_62("okControl",(_61.okLink?"link":(_61.okButton?"button":_61.okLink==_61.okButton==false?false:undefined)));_62("highlightColor",_61.highlightcolor);_62("highlightEndColor",_61.highlightendcolor);};Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:"link",cancelText:"cancel",clickToEditText:"Click to edit",externalControl:null,externalControlOnly:false,fieldPostCreation:"activate",formClassName:"inplaceeditor-form",formId:null,highlightColor:"#ffff99",highlightEndColor:"#ffffff",hoverClassName:"",htmlResponse:true,loadingClassName:"inplaceeditor-loading",loadingText:"Loading...",okControl:"button",okText:"ok",paramName:"value",rows:1,savingClassName:"inplaceeditor-saving",savingText:"Saving...",size:0,stripLoadedTextTags:false,submitOnBlur:false,textAfterControls:"",textBeforeControls:"",textBetweenControls:""},DefaultCallbacks:{callback:function(_65){return Form.serialize(_65);},onComplete:function(_66,_67){new Effect.Highlight(_67,{startcolor:this.options.highlightColor,keepBackgroundImage:true});},onEnterEditMode:null,onEnterHover:function(ipe){ipe.element.style.backgroundColor=ipe.options.highlightColor;if(ipe._effect){ipe._effect.cancel();}},onFailure:function(_68,ipe){alert("Error communication with the server: "+_68.responseText.stripTags());},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(ipe){ipe._effect=new Effect.Highlight(ipe.element,{startcolor:ipe.options.highlightColor,endcolor:ipe.options.highlightEndColor,restorecolor:ipe._originalBackground,keepBackgroundImage:true});}},Listeners:{click:"enterEditMode",keydown:"checkForEscapeOrReturn",mouseover:"enterHover",mouseout:"leaveHover"}});Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:"Loading options..."};Form.Element.DelayedObserver=Class.create({initialize:function(_69,_6a,_6b){this.delay=_6a||0.5;this.element=$(_69);this.callback=_6b;this.timer=null;this.lastValue=$F(this.element);Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this));},delayedListener:function(_6c){if(this.lastValue==$F(this.element)){return;}if(this.timer){clearTimeout(this.timer);}this.timer=setTimeout(this.onTimerEvent.bind(this),this.delay*1000);this.lastValue=$F(this.element);},onTimerEvent:function(){this.timer=null;this.callback(this.element,$F(this.element));}});